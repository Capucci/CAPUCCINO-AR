<!DOCTYPE html>
<html>
<head>
   <script>
const VERSION = "1.4.0"; 
// ↑ SEMPRE que atualizar modelo/vídeo ou target,
// só mude esse número
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

<!-- NECESSÁRIO PARA ANIMAÇÃO -->
<script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

<style>
body { margin:0; overflow:hidden; }

/* Botão de VR no canto inferior direito */
.a-enter-vr {
  position: fixed;
  bottom: 20px !important;
  right: 20px !important;
  left: auto !important;
  top: auto !important;
  transform: none !important;
}
</style>

</head>

<body>

<a-scene
  mindar-image="imageTargetSrc: Target01.mind;"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false"
  embedded
  renderer="colorManagement: true;"
  background="color: black">

  <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

  <a-entity mindar-image-target="targetIndex: 0" id="target-principal">

    <!-- GRUPO PARA CONTROLAR TUDO JUNTO -->
    <a-entity id="grupo-principal" position="0 0 0.3">

      <!-- MODELO 3D - Lado esquerdo -->
      <a-entity
        id="mascote"
        gltf-model="MascoteDanca.glb"
        animation-mixer
        position="-0.8 0 0"
        rotation="0 0 0"
        scale="0.7 0.7 0.7">
      </a-entity>

      <!-- VÍDEO - Lado direito -->
      <a-video
        id="video-mascote"
        src="#meuVideo"
        position="0.8 0 0"
        rotation="0 0 0"
        width="1.2"
        height="0.8"
        material="side: double;">
      </a-video>

    </a-entity>

  </a-entity>

  <!-- Elemento de vídeo HTML5 escondido -->
  <video id="meuVideo" preload="auto" loop="false" crossorigin="anonymous" style="display: none;">
    <source src="Video Antecipe Portugues 1.mp4" type="video/mp4">
  </video>

  <!-- Elemento de áudio HTML5 escondido (música de fundo) -->
  <audio id="musicaFundo" preload="auto" style="display: none;" loop="false">
    <source src="Moo.mp3" type="audio/mpeg">
  </audio>

  <script>
document.addEventListener("DOMContentLoaded", function () {

  const target = document.querySelector('#target-principal');
  
  // Elementos de mídia
  const videoElement = document.querySelector('#meuVideo');
  const audioElement = document.querySelector('#musicaFundo');
  
  // Variáveis de controle
  let mediaUnlocked = false;
  let videoPausedTime = 0;
  let audioPausedTime = 0;
  let isVideoPlaying = false;
  let isAudioPlaying = false;
  let firstTargetFound = false;

  // Função para tentar tocar tudo
  function tryPlayAll() {
    if (!mediaUnlocked) {
      // Tenta tocar vídeo e áudio juntos
      Promise.all([
        videoElement.play(),
        audioElement.play()
      ])
        .then(() => {
          mediaUnlocked = true;
          isVideoPlaying = true;
          isAudioPlaying = true;
          console.log('Vídeo e áudio desbloqueados!');
        })
        .catch(error => {
          console.log('Não foi possível tocar automaticamente:', error);
          mediaUnlocked = false;
        });
    } else {
      // Se já desbloqueado, toca de onde parou
      if (!isVideoPlaying) {
        if (videoPausedTime > 0) videoElement.currentTime = videoPausedTime;
        videoElement.play()
          .then(() => isVideoPlaying = true)
          .catch(e => console.log('Erro vídeo:', e));
      }
      
      if (!isAudioPlaying) {
        if (audioPausedTime > 0) audioElement.currentTime = audioPausedTime;
        audioElement.play()
          .then(() => isAudioPlaying = true)
          .catch(e => console.log('Erro áudio:', e));
      }
    }
  }

  // Função para pausar tudo
  function pauseAll() {
    if (isVideoPlaying) {
      videoPausedTime = videoElement.currentTime;
      videoElement.pause();
      isVideoPlaying = false;
    }
    
    if (isAudioPlaying) {
      audioPausedTime = audioElement.currentTime;
      audioElement.pause();
      isAudioPlaying = false;
    }
    
    console.log('Tudo pausado');
  }

  // ▶ Quando reconhecer o target
  target.addEventListener("targetFound", () => {
    console.log('Target encontrado!');
    firstTargetFound = true;
    tryPlayAll();
  });

  // ⏹ Quando perder o target
  target.addEventListener("targetLost", () => {
    console.log('Target perdido!');
    pauseAll();
  });

  // Quando as mídias terminarem
  videoElement.addEventListener('ended', function() {
    isVideoPlaying = false;
    videoPausedTime = 0;
    console.log('Vídeo terminou');
  });
  
  audioElement.addEventListener('ended', function() {
    isAudioPlaying = false;
    audioPausedTime = 0;
    console.log('Áudio terminou');
  });

  // Desbloqueio por interação do usuário
  function unlockMedia() {
    if (firstTargetFound && !mediaUnlocked) {
      Promise.all([
        videoElement.play(),
        audioElement.play()
      ])
        .then(() => {
          mediaUnlocked = true;
          isVideoPlaying = true;
          isAudioPlaying = true;
          console.log('Desbloqueado por interação!');
        })
        .catch(e => console.log('Aguardando interação...'));
    }
  }

  document.body.addEventListener('click', unlockMedia);
  document.body.addEventListener('touchstart', unlockMedia);

  // Monitorar tempos
  setInterval(() => {
    if (isVideoPlaying) videoPausedTime = videoElement.currentTime;
    if (isAudioPlaying) audioPausedTime = audioElement.currentTime;
  }, 1000);

  // Pré-carrega
  videoElement.load();
  audioElement.load();

});
</script>

</body>
</html>

