<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- Componente para bot√µes interativos -->
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        
        /* Bot√£o flutuante para debug (opcional) */
        .debug-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Instru√ß√µes */
        .instructions {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            z-index: 9999;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="instructions">
        üëÜ Clique nos bot√µes 3D para mudar de cena
    </div>

    <!-- Bot√£o de debug (opcional) -->
    <div class="debug-btn" onclick="showCurrentScene()">
        üé¨ Cena Atual
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: targets.mind;" 
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        embedded
        raycaster="far: 10; objects: .clickable"
        cursor="rayOrigin: mouse">

        <a-camera position="0 0 0" look-controls="enabled: false">
            <!-- Cursor para clique com mouse/touch -->
            <a-entity cursor="fuse: false; rayOrigin: mouse"
                      raycaster="objects: .clickable"
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: cyan; shader: flat"
                      position="0 0 -1"
                      scale="0.5 0.5 0.5">
            </a-entity>
        </a-camera>

        <!-- ========================================= -->
        <!-- TARGET PRINCIPAL (FACE DO CUBO)          -->
        <!-- ========================================= -->
        <a-entity mindar-image-target="targetIndex: 0" id="target-principal">

            <!-- SISTEMA DE GERENCIAMENTO DE CENAS -->
            <a-entity id="scene-manager" 
                      data-current-scene="cena-sol"
                      data-target="target-principal">
            </a-entity>

            <!-- ===================================== -->
            <!-- CENA 1: SOL (anima√ß√£o padr√£o)        -->
            <!-- ===================================== -->
            <a-entity id="cena-sol" class="scene" visible="true">
                <!-- P√© de milho no sol -->
                <a-entity gltf-model="milho.glb"
                          animation-mixer="clip: sol; loop: repeat;"
                          position="0 0 0.3"
                          scale="0.7 0.7 0.7"
                          rotation="-90 0 0">
                </a-entity>

                <!-- Bot√£o de chuva (OBJETO 3D CLIC√ÅVEL) -->
                <a-entity class="clickable"
                          geometry="primitive: plane; width: 0.2; height: 0.2"
                          material="color: blue; transparent: true; opacity: 0.8"
                          position="0.3 0.2 0.3"
                          rotation="-90 0 0"
                          data-action="change-scene"
                          data-target-scene="cena-chuva"
                          data-btn-type="scene"
                          data-btn-name="chuva">
                    
                    <!-- Texto no bot√£o -->
                    <a-entity text="value: üåßÔ∏è; color: white; align: center; width: 2"
                              position="0 0 0.01"
                              scale="0.5 0.5 0.5">
                    </a-entity>

                    <!-- Anima√ß√£o de hover -->
                    <a-animation attribute="scale"
                                 to="1.1 1.1 1.1"
                                 dur="300"
                                 startEvents="mouseenter"
                                 fill="forwards">
                    </a-animation>
                    <a-animation attribute="scale"
                                 to="1 1 1"
                                 dur="300"
                                 startEvents="mouseleave"
                                 fill="forwards">
                    </a-animation>
                </a-entity>

                <!-- Bot√£o de site (URL) -->
                <a-entity class="clickable"
                          geometry="primitive: plane; width: 0.15; height: 0.15"
                          material="color: green; transparent: true; opacity: 0.8"
                          position="0.5 0.2 0.3"
                          rotation="-90 0 0"
                          data-action="open-url"
                          data-url="https://meusite.com"
                          data-btn-type="url">
                    
                    <a-entity text="value: üåê; color: white; align: center"
                              position="0 0 0.01"
                              scale="0.4 0.4 0.4">
                    </a-entity>
                </a-entity>

                <!-- Bot√£o de WhatsApp -->
                <a-entity class="clickable"
                          geometry="primitive: plane; width: 0.15; height: 0.15"
                          material="color: green; transparent: true; opacity: 0.8"
                          position="-0.3 0.2 0.3"
                          rotation="-90 0 0"
                          data-action="open-url"
                          data-url="https://wa.me/5511999999999?text=Ol√°%20do%20AR"
                          data-btn-type="whatsapp">
                    
                    <a-entity text="value: üì±; color: white; align: center"
                              position="0 0 0.01"
                              scale="0.4 0.4 0.4">
                    </a-entity>
                </a-entity>

                <!-- Bot√£o de Email -->
                <a-entity class="clickable"
                          geometry="primitive: plane; width: 0.15; height: 0.15"
                          material="color: red; transparent: true; opacity: 0.8"
                          position="-0.5 0.2 0.3"
                          rotation="-90 0 0"
                          data-action="open-url"
                          data-url="mailto:contato@meusite.com?subject=AR%20Experience"
                          data-btn-type="email">
                    
                    <a-entity text="value: ‚úâÔ∏è; color: white; align: center"
                              position="0 0 0.01"
                              scale="0.4 0.4 0.4">
                    </a-entity>
                </a-entity>
            </a-entity>

            <!-- ===================================== -->
            <!-- CENA 2: CHUVA                         -->
            <!-- ===================================== -->
            <a-entity id="cena-chuva" class="scene" visible="false">
                <!-- P√© de milho na chuva -->
                <a-entity gltf-model="milho.glb"
                          animation-mixer="clip: chuva; loop: repeat;"
                          position="0 0 0.3"
                          scale="0.7 0.7 0.7"
                          rotation="-90 0 0">
                </a-entity>

                <!-- Bot√£o de voltar ao sol -->
                <a-entity class="clickable"
                          geometry="primitive: plane; width: 0.2; height: 0.2"
                          material="color: yellow; transparent: true; opacity: 0.8"
                          position="0.3 0.2 0.3"
                          rotation="-90 0 0"
                          data-action="change-scene"
                          data-target-scene="cena-sol"
                          data-btn-type="back">
                    
                    <a-entity text="value: ‚òÄÔ∏è; color: black; align: center"
                              position="0 0 0.01"
                              scale="0.5 0.5 0.5">
                    </a-entity>
                </a-entity>

                <!-- Bot√£o de WhatsApp na chuva -->
                <a-entity class="clickable"
                          geometry="primitive: plane; width: 0.15; height: 0.15"
                          material="color: green; transparent: true; opacity: 0.8"
                          position="-0.3 0.2 0.3"
                          rotation="-90 0 0"
                          data-action="open-url"
                          data-url="https://wa.me/5511999999999?text=Estou%20na%20cena%20da%20chuva"
                          data-btn-type="whatsapp">
                    
                    <a-entity text="value: üì±; color: white; align: center"
                              position="0 0 0.01"
                              scale="0.4 0.4 0.4">
                    </a-entity>
                </a-entity>

                <!-- Efeito de chuva (part√≠culas) -->
                <a-entity particle-system="
                    preset: rain;
                    color: #00ffff;
                    particleCount: 1000;
                    velocity: 0 -2 0;
                    acceleration: 0 -5 0;
                " position="0 0.5 0.3">
                </a-entity>
            </a-entity>

            <!-- ===================================== -->
            <!-- CENA 3: NOITE (exemplo extra)        -->
            <!-- ===================================== -->
            <a-entity id="cena-noite" class="scene" visible="false">
                <!-- P√© de milho √† noite -->
                <a-entity gltf-model="milho.glb"
                          animation-mixer="clip: noite; loop: repeat;"
                          position="0 0 0.3"
                          scale="0.7 0.7 0.7"
                          rotation="-90 0 0">
                </a-entity>

                <!-- Bot√£o de voltar ao sol -->
                <a-entity class="clickable"
                          geometry="primitive: plane; width: 0.2; height: 0.2"
                          material="color: yellow; transparent: true; opacity: 0.8"
                          position="0.3 0.2 0.3"
                          rotation="-90 0 0"
                          data-action="change-scene"
                          data-target-scene="cena-sol"
                          data-btn-type="back">
                    
                    <a-entity text="value: ‚òÄÔ∏è; color: black; align: center"
                              position="0 0 0.01"
                              scale="0.5 0.5 0.5">
                    </a-entity>
                </a-entity>

                <!-- Vagalumes (part√≠culas) -->
                <a-entity particle-system="
                    preset: default;
                    color: #ffff00;
                    particleCount: 50;
                    velocity: 0.1 0.1 0.1;
                    acceleration: 0 0 0;
                " position="0 0.2 0.3">
                </a-entity>
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        // ============================================
        // SISTEMA DE GERENCIAMENTO DE CENAS
        // ============================================
        document.addEventListener("DOMContentLoaded", function() {
            console.log("üöÄ Sistema de cenas iniciado");
            
            const target = document.getElementById('target-principal');
            const sceneManager = document.getElementById('scene-manager');
            
            // Mapeamento de cenas
            const scenes = {
                'cena-sol': document.getElementById('cena-sol'),
                'cena-chuva': document.getElementById('cena-chuva'),
                'cena-noite': document.getElementById('cena-noite')
            };

            // Estado atual
            let currentScene = 'cena-sol';
            let targetVisible = false;
            let sceneTimes = {
                'cena-sol': 0,
                'cena-chuva': 0,
                'cena-noite': 0
            };

            // ============================================
            // FUN√á√ÉO PARA MUDAR DE CENA
            // ============================================
            window.changeScene = function(newSceneId) {
                if (!scenes[newSceneId]) {
                    console.error('Cena n√£o encontrada:', newSceneId);
                    return;
                }

                console.log(`üîÑ Mudando de cena: ${currentScene} ‚Üí ${newSceneId}`);

                // Salvar tempo da cena atual
                saveCurrentSceneTime();

                // Esconder todas as cenas
                Object.values(scenes).forEach(scene => {
                    if (scene) scene.setAttribute('visible', 'false');
                });

                // Mostrar nova cena
                scenes[newSceneId].setAttribute('visible', 'true');
                
                // Restaurar tempo da nova cena
                restoreSceneTime(newSceneId);

                // Atualizar estado
                currentScene = newSceneId;
                sceneManager.setAttribute('data-current-scene', newSceneId);
            };

            // ============================================
            // FUN√á√ïES DE CONTROLE DE TEMPO
            // ============================================
            function saveCurrentSceneTime() {
                const scene = scenes[currentScene];
                if (!scene) return;

                // Salvar tempo dos modelos 3D na cena
                const models = scene.querySelectorAll('[gltf-model]');
                models.forEach((model, index) => {
                    if (model.components['animation-mixer']) {
                        // Infelizmente o animation-mixer n√£o exp√µe o tempo atual
                        // Mas podemos usar o √°udio como refer√™ncia
                        console.log('Salvando tempo da anima√ß√£o');
                    }
                });

                // Salvar tempo dos v√≠deos na cena
                const videos = scene.querySelectorAll('video');
                videos.forEach(video => {
                    sceneTimes[currentScene] = video.currentTime || 0;
                });

                // Salvar tempo dos √°udios
                const audios = scene.querySelectorAll('[sound]');
                audios.forEach(audio => {
                    if (audio.components.sound) {
                        sceneTimes[currentScene] = audio.components.sound.currentTime || 0;
                    }
                });
            }

            function restoreSceneTime(sceneId) {
                const scene = scenes[sceneId];
                if (!scene) return;

                const savedTime = sceneTimes[sceneId] || 0;

                // Restaurar tempo dos v√≠deos
                const videos = scene.querySelectorAll('video');
                videos.forEach(video => {
                    video.currentTime = savedTime;
                });

                // Restaurar tempo dos √°udios
                const audios = scene.querySelectorAll('[sound]');
                audios.forEach(audio => {
                    if (audio.components.sound) {
                        audio.components.sound.currentTime = savedTime;
                    }
                });

                console.log(`‚è±Ô∏è Cena ${sceneId} restaurada no tempo: ${savedTime}s`);
            }

            // ============================================
            // DETEC√á√ÉO DE CLIQUE NOS BOT√ïES
            // ============================================
            document.querySelectorAll('.clickable').forEach(btn => {
                btn.addEventListener('click', function(evt) {
                    evt.stopPropagation();
                    
                    const action = this.getAttribute('data-action');
                    const btnType = this.getAttribute('data-btn-type');
                    
                    console.log('üëÜ Bot√£o clicado:', {
                        action: action,
                        type: btnType,
                        element: this
                    });

                    // Feedback visual do clique
                    this.setAttribute('material', 'color', 'white');
                    setTimeout(() => {
                        if (btnType === 'url') this.setAttribute('material', 'color', 'green');
                        else if (btnType === 'whatsapp') this.setAttribute('material', 'color', 'green');
                        else if (btnType === 'email') this.setAttribute('material', 'color', 'red');
                        else if (btnType === 'back') this.setAttribute('material', 'color', 'yellow');
                        else this.setAttribute('material', 'color', 'blue');
                    }, 200);

                    // Processar a√ß√£o
                    if (action === 'change-scene') {
                        const targetScene = this.getAttribute('data-target-scene');
                        changeScene(targetScene);
                    }
                    else if (action === 'open-url') {
                        const url = this.getAttribute('data-url');
                        console.log('üîó Abrindo URL:', url);
                        window.open(url, '_blank');
                    }
                });

                // Efeitos de hover
                btn.addEventListener('mouseenter', function() {
                    this.setAttribute('material', 'color', '#ffaa00');
                });

                btn.addEventListener('mouseleave', function() {
                    const btnType = this.getAttribute('data-btn-type');
                    if (btnType === 'url') this.setAttribute('material', 'color', 'green');
                    else if (btnType === 'whatsapp') this.setAttribute('material', 'color', 'green');
                    else if (btnType === 'email') this.setAttribute('material', 'color', 'red');
                    else if (btnType === 'back') this.setAttribute('material', 'color', 'yellow');
                    else this.setAttribute('material', 'color', 'blue');
                });
            });

            // ============================================
            // CONTROLE DE TARGET (visibilidade)
            // ============================================
            target.addEventListener('targetFound', () => {
                console.log('üéØ Target encontrado!');
                targetVisible = true;
                
                // Restaurar cena atual
                restoreSceneTime(currentScene);
                
                // Iniciar anima√ß√µes
                Object.values(scenes).forEach(scene => {
                    const models = scene.querySelectorAll('[gltf-model]');
                    models.forEach(model => {
                        if (model.components['animation-mixer']) {
                            model.setAttribute('animation-mixer', 'timeScale', 1);
                        }
                    });
                });
            });

            target.addEventListener('targetLost', () => {
                console.log('üö´ Target perdido!');
                targetVisible = false;
                
                // Salvar tempo da cena atual
                saveCurrentSceneTime();
                
                // Pausar anima√ß√µes
                Object.values(scenes).forEach(scene => {
                    const models = scene.querySelectorAll('[gltf-model]');
                    models.forEach(model => {
                        if (model.components['animation-mixer']) {
                            model.setAttribute('animation-mixer', 'timeScale', 0);
                        }
                    });
                });
            });

            // ============================================
            // FUN√á√ÉO DE DEBUG
            // ============================================
            window.showCurrentScene = function() {
                alert(`Cena atual: ${currentScene}\nTempo: ${sceneTimes[currentScene]}s`);
            };

            // Inicializar cena padr√£o
            changeScene('cena-sol');
        });
    </script>

    <!-- ============================================ -->
    <!-- COMPONENTE PERSONALIZADO PARA BOT√ïES        -->
    <!-- ============================================ -->
    <script>
        // Componente A-Frame para bot√µes inteligentes
        AFRAME.registerComponent('smart-button', {
            schema: {
                type: { type: 'string', default: 'scene' }, // scene, url, email, whatsapp
                target: { type: 'string', default: '' },
                url: { type: 'string', default: '' },
                color: { type: 'color', default: '#3366ff' },
                hoverColor: { type: 'color', default: '#44aaff' },
                icon: { type: 'string', default: 'üîò' }
            },

            init: function() {
                this.el.classList.add('clickable');
                
                // Criar texto do bot√£o
                const textEl = document.createElement('a-entity');
                textEl.setAttribute('text', {
                    value: this.data.icon,
                    color: 'white',
                    align: 'center',
                    width: 2
                });
                textEl.setAttribute('position', '0 0 0.01');
                textEl.setAttribute('scale', '0.5 0.5 0.5');
                this.el.appendChild(textEl);

                // Configurar eventos
                this.el.addEventListener('click', this.onClick.bind(this));
                this.el.addEventListener('mouseenter', this.onMouseEnter.bind(this));
                this.el.addEventListener('mouseleave', this.onMouseLeave.bind(this));
            },

            onClick: function() {
                console.log('Smart button clicked:', this.data);
                
                // Feedback visual
                this.el.setAttribute('material', 'color', 'white');
                setTimeout(() => {
                    this.el.setAttribute('material', 'color', this.data.color);
                }, 200);

                // Processar a√ß√£o
                switch(this.data.type) {
                    case 'scene':
                        if (window.changeScene) {
                            window.changeScene(this.data.target);
                        }
                        break;
                    case 'url':
                    case 'whatsapp':
                    case 'email':
                        window.open(this.data.url, '_blank');
                        break;
                }
            },

            onMouseEnter: function() {
                this.el.setAttribute('material', 'color', this.data.hoverColor);
                this.el.setAttribute('scale', '1.1 1.1 1.1');
            },

            onMouseLeave: function() {
                this.el.setAttribute('material', 'color', this.data.color);
                this.el.setAttribute('scale', '1 1 1');
            }
        });
    </script>
</body>
</html>
